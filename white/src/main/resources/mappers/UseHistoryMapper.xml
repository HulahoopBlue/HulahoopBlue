<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hulahoopblue.white.usehistory.model.dao.UseHistoryMapper">

    <resultMap id="useHistoryResultMap" type="com.hulahoopblue.white.usehistory.model.dto.UseHistoryDTO">
        <id property="transactionNum" column="transaction_num"/>
        <result property="memberNum" column="member_num"/>
        <result property="phoneNum" column="phone_num"/>
        <result property="categoryCd" column="category_cd"/>
        <result property="merchantNum" column="merchant_num"/>
        <result property="brokerage" column="brokerage"/>
        <result property="paymentDateTime" column="payment_date_time"/>
        <result property="useStartDateTime" column="use_start_date_time"/>
        <result property="useEndDateTime" column="use_end_date_time"/>
        <result property="reservationStatus" column="reservation_status"/>
        <result property="merchantNm" column="merchant_nm"/> <!-- ✅ 추가 -->
    </resultMap>


    <resultMap id="merchantResultMap" type="com.hulahoopblue.white.merchant.model.dto.MerchantDTO">
        <id property="merchantNum" column="merchant_num"/>
        <result property="categoryCd" column="category_cd"/>
        <result property="merchantNm" column="merchant_nm"/>
        <result property="apiKey" column="api_key"/>
        <result property="businessNum" column="business_num"/>
        <result property="regDateTime" column="reg_date_time"/>
        <result property="modifyDateTime" column="modify_date_time"/>
        <result property="endDateTime" column="end_date_time"/>
        <result property="brokerageRate" column="brokerage_rate"/>
        <result property="brokerage" column="brokerage"/>
        <result property="contractStatus" column="contract_status"/>
    </resultMap>

    <!-- 이용내역 조회 -->
    <select id="selectUseHistories" resultMap="useHistoryResultMap">
        SELECT
        uh.transaction_num,
        uh.member_num,
        uh.phone_num,
        uh.category_cd,
        uh.merchant_num,
        uh.brokerage,
        uh.payment_date_time,
        uh.use_start_date_time,
        uh.use_end_date_time,
        uh.reservation_status,
        m.merchant_nm
        FROM T_UseHistory uh
        LEFT JOIN T_Merchant m ON uh.merchant_num = m.merchant_num
        WHERE 1=1
        <if test="categoryCd != null and categoryCd != ''">
            AND uh.category_cd = #{categoryCd}
        </if>
        <if test="merchantNum != null and merchantNum != ''">
            AND uh.merchant_num = #{merchantNum}
        </if>
        <if test="startDate != null">
            AND uh.payment_date_time &gt;= #{startDate}
        </if>
        <if test="endDate != null">
            AND uh.payment_date_time &lt; #{endDate} + interval 1 day
        </if>


        ORDER BY uh.payment_date_time DESC
    </select>



    <!-- 카테고리 목록 조회 -->
    <select id="selectCategoryList" resultType="String">
        SELECT DISTINCT category_cd
        FROM T_UseHistory
        ORDER BY category_cd
    </select>

    <!-- 가맹점 목록 조회 -->
    <select id="selectMerchantList" resultMap="merchantResultMap">
        SELECT *
        FROM T_Merchant
        ORDER BY merchant_nm
    </select>

</mapper>
