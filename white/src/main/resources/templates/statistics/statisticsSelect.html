<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>통계 조회</title>

  <link rel="stylesheet" th:href="@{/css/style.css}"/>

  <style>
    /* 페이지별 고유 CSS */
    .container, table, #example_wrapper {
      background-color: transparent !important;
    }

    #example th, #example td {
      text-align: center;
      vertical-align: middle;
    }
  </style>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css"/>
</head>
<body class="bg-gray-50">

<div class="topbar">
  <!-- 왼쪽: 로고 (대쉬보드로 이동) -->
  <div style="display: flex; align-items: center; gap: 10px;">
    <a href="/dashboard/dashboardSelect">
      <img src="/img/KakaoTalk_20250923_163110071.png" alt="로고" style="height: 30px; cursor: pointer;">
    </a>
  </div>

  <!-- 오른쪽: 관리자 이름 + 세션 시간 -->
  <div style="display: flex; flex-direction: column; align-items: flex-end; line-height: 1.4;">
    <span id="loginUserName" style="color: black; font-size: 14px; font-weight: bold;"></span>
    <span style="color: black; font-size: 12px;">
            남은 세션 시간: <span id="session-timer"></span>
                        </span>
  </div>
</div>

<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <h2 class="text-2xl font-bold mb-4">통계 조회</h2>

  <div id="custom-toolbar" class="flex flex-col sm:flex-row items-center justify-center gap-3 mb-6">
    <label for="categorySelect">카테고리:</label>
    <select id="categorySelect" class="border border-gray-300 rounded-xl px-3 py-2 bg-white"></select>

    <label for="merchantSelect">가맹점:</label>
    <select id="merchantSelect" class="border border-gray-300 rounded-xl px-3 py-2 bg-white"></select>

    <label for="startDate">시작일:</label>
    <input type="date" id="startDate" class="border border-gray-300 rounded-xl px-3 py-2 bg-white">

    <label for="endDate">종료일:</label>
    <input type="date" id="endDate" class="border border-gray-300 rounded-xl px-3 py-2 bg-white">

    <button id="searchBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700">조회</button>
    <button id="resetBtn" class="px-4 py-2 rounded-xl bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300">초기화</button>
  </div>

  <table id="example" class="table-auto w-full">
    <thead>
    <tr>
      <th>가맹점명</th>
      <th>결제 날짜</th>
      <th>건수</th>
      <th>사용금액</th>
    </tr>
    </thead>
    <tbody id="resultTable"></tbody>
    <tfoot>
    <tr>
      <th colspan="3">총합계</th>
      <th id="totalAmt">0</th>
    </tr>
    </tfoot>
  </table>
</div>

<div class="dropdown-wrapper">
  <button class="dropdown-trigger">
    <div class="icon"></div>
  </button>
  <div class="dropdown-menu">
    <div class="dropdown-item" data-href="/dashboard/dashboardSelect" onclick="location.href='/dashboard/dashboardSelect'">
      <span>대시보드</span>
    </div>
    <div class="dropdown-item" data-href="/statistics/statisticsSelect" onclick="location.href='/statistics/statisticsSelect'">
      <span>통계</span>
    </div>
    <div class="dropdown-item" data-href="/usehistory/usehistorySelect" onclick="location.href='/usehistory/usehistorySelect'">
      <span>이용내역</span>
    </div>
    <div class="dropdown-item" data-href="/merchant/merchantSelect" onclick="location.href='/merchant/merchantSelect'">
      <span>가맹점관리</span>
    </div>
    <div class="dropdown-item" data-href="/member/memberSelect" onclick="location.href='/member/memberSelect'">
      <span>개인회원관리</span>
    </div>
    <div class="dropdown-divider"></div>
    <div class="dropdown-item" onclick="location.href='/auth/logout'">
      <span>로그아웃</span>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>

<script th:inline="javascript">
  const loginMember = /*[[${session.loginMember}]]*/ null;
  let remainingTime = /*[[${session.sessionTimeout}]]*/ 1800;

  if (!loginMember) {
    alert("로그인 후 이용 가능합니다.");
    window.location.href = "/auth/login";
  } else if (loginMember.userTyp != 2) {
    alert("관리자만 접근 가능합니다.");
    window.location.href = "/auth/login";
  } else {
    document.getElementById("loginUserName").textContent = loginMember.nm + " (" + loginMember.id + ")";
  }

  function startCountdown() {
    const timerElement = document.getElementById("session-timer");
    const interval = setInterval(() => {
      if (remainingTime <= 0) {
        clearInterval(interval);
        alert("세션이 만료되었습니다. 다시 로그인해주세요.");
        window.location.href = "/auth/logout";
      } else {
        const minutes = Math.floor(remainingTime / 60);
        const seconds = remainingTime % 60;
        timerElement.textContent = minutes + "분 " + seconds + "초";
        remainingTime--;
      }
    }, 1000);
  }
  window.onload = startCountdown;

  let allMerchants = [];
  let table;

  window.addEventListener('DOMContentLoaded', () => {
    const today = new Date();
    const sixMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 6, today.getDate());
    document.getElementById('startDate').valueAsDate = sixMonthsAgo;
    document.getElementById('endDate').valueAsDate = today;

    fetch('/usehistory/categories')
            .then(res => res.json())
            .then(data => {
              const categorySelect = document.getElementById('categorySelect');
              categorySelect.innerHTML = `<option value="">전체</option>`;
              data.forEach(cat => categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`);
            });

    fetch('/usehistory/merchants')
            .then(res => res.json())
            .then(data => {
              allMerchants = data;
              updateMerchantSelect();
              searchStatistics();
            });

    table = $('#example').DataTable({
      pageLength: 10,
      lengthMenu: [10, 15, 20],
      lengthChange: true,
      dom: 'lrtip',
      language: {
        search: "검색:",
        info: "총 _TOTAL_개 중 _START_–_END_",
        infoEmpty: "0개",
        zeroRecords: "결과가 없습니다"
      },
      paging: true,
      pagingType: 'simple',
      drawCallback: function(settings) {
        var api = this.api();
        var pageInfo = api.page.info();
        const currentPage = pageInfo.pages === 0 ? 1 : pageInfo.page + 1;
        const totalPages = pageInfo.pages === 0 ? 1 : pageInfo.pages;
        $('#example_paginate').html(`
                    <div class="flex items-center justify-center gap-2 mt-4">
                        <button id="prevPage" class="px-3 py-1 rounded bg-blue-500 text-white hover:bg-blue-600 disabled:bg-gray-300" ${pageInfo.page === 0 ? 'disabled' : ''}>이전</button>
                        <span class="font-semibold text-gray-700">${currentPage} / ${totalPages}</span>
                        <button id="nextPage" class="px-3 py-1 rounded bg-blue-500 text-white hover:bg-blue-600 disabled:bg-gray-300" ${pageInfo.page + 1 === pageInfo.pages ? 'disabled' : ''}>다음</button>
                    </div>
                `);
        $('#prevPage').off('click').on('click', () => api.page('previous').draw('page'));
        $('#nextPage').off('click').on('click', () => api.page('next').draw('page'));
      }
    });
  });

  document.getElementById('categorySelect').addEventListener('change', updateMerchantSelect);

  function updateMerchantSelect() {
    const categoryCd = document.getElementById('categorySelect').value;
    const merchantSelect = document.getElementById('merchantSelect');
    merchantSelect.innerHTML = `<option value="">전체</option>`;
    const filtered = categoryCd ? allMerchants.filter(m => m.categoryCd === categoryCd) : allMerchants;
    filtered.forEach(m => merchantSelect.innerHTML += `<option value="${m.merchantNum}">${m.merchantNm}</option>`);
  }

  document.getElementById('searchBtn').addEventListener('click', searchStatistics);

  function searchStatistics() {
    const categoryCd = document.getElementById('categorySelect').value;
    const merchantNum = document.getElementById('merchantSelect').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    const params = new URLSearchParams();
    if (categoryCd) params.append('categoryCd', categoryCd);
    if (merchantNum) params.append('merchantNum', merchantNum);
    if (startDate) params.append('startDate', startDate);
    if (endDate) params.append('endDate', endDate);

    fetch('/statistics/list?' + params)
            .then(res => res.json())
            .then(data => {
              table.clear();
              let totalAmt = 0;

              data.forEach(item => {
                table.row.add([
                  item.merchantNm,
                  item.paymentDateTime,
                  item.useCnt,
                  item.brokerage
                ]);
                totalAmt += Number(item.brokerage) || 0;
              });

              table.draw();
              document.getElementById('totalAmt').textContent = parseInt(totalAmt);
            });
  }

  document.getElementById('resetBtn').addEventListener('click', () => {
    const today = new Date();
    const sixMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 6, today.getDate());
    document.getElementById('startDate').valueAsDate = sixMonthsAgo;
    document.getElementById('endDate').valueAsDate = today;
    document.getElementById('categorySelect').value = '';
    document.getElementById('merchantSelect').value = '';
    searchStatistics();
  });
</script>
<script th:src="@{/js/script.js}"></script>

</body>
</html>