<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>가맹점 목록</title>

    <style>
        :root {
            --primary: #2196f3;
            --primary-glow: rgba(33, 150, 243, 0.4);
            --background: #0a0a12;
            --surface: rgba(30, 30, 45, 0.95);
            --surface-hover: rgba(40, 40, 60, 0.95);
            --text: #ffffff;
            --border: rgba(255, 255, 255, 0.1);
            --shadow: rgba(0, 0, 0, 0.3);
            --glow: 0 0 10px var(--primary-glow);
            --glass: saturate(180%) blur(10px);
            --gradient: linear-gradient(135deg, var(--surface), rgba(40, 40, 60, 0.95));
            --transition-medium: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --border-radius: 8px;
        }

        html, body {
            height: 100%;
            margin: 0;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(180deg, #EDFAFF 0%, #F0FFF5 100%);
        }

        .container, table, #example_wrapper {
            background-color: transparent !important;
        }

        #example th, #example td {
            text-align: center;
            vertical-align: middle;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ccc;
        }
        .topbar span { font-weight: bold; font-size: 1rem; }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css"/>
</head>
<body class="bg-gray-50">

<div class="topbar">
    <span id="loginUserName"></span>
    <span>남은 세션 시간: <span id="session-timer"></span></span>
</div>

<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h2 class="text-2xl font-bold mb-4">가맹점 목록</h2>

    <div id="custom-toolbar" class="flex flex-col sm:flex-row items-center justify-center gap-3 mb-6 flex-wrap">
        <label for="categorySelect">카테고리:</label>
        <select id="categorySelect" class="border border-gray-300 rounded-xl px-3 py-2 bg-white"></select>

        <label for="merchantNm">가맹점명:</label>
        <input type="text" id="merchantNm" class="w-[10%] border border-gray-300 rounded-xl px-3 py-2 bg-white" placeholder="">

        <label for="businessNum">사업자번호:</label>
        <input type="text" id="businessNum" class="w-[10%] border border-gray-300 rounded-xl px-3 py-2 bg-white" placeholder="">

        <label for="contractStatus">계약상태:</label>
        <select id="contractStatus" class="border border-gray-300 rounded-xl px-3 py-2 bg-white">
            <option value="">전체</option>
            <option value="U">계약중</option>
            <option value="C">해지</option>
            <option value="T">종료</option>
        </select>

        <label for="startDate">등록일:</label>
        <input type="date" id="startDate" class="border border-gray-300 rounded-xl px-3 py-2 bg-white">

        <label for="endDate">등록일:</label>
        <input type="date" id="endDate" class="border border-gray-300 rounded-xl px-3 py-2 bg-white">

        <button id="searchBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700">검색</button>
        <button id="resetBtn" class="px-4 py-2 rounded-xl bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300">초기화</button>
    </div>

    <table id="example" class="table-auto w-full">
        <thead>
        <tr>
            <th>가맹점번호</th>
            <th>가맹점명</th>
            <th>사업자번호</th>
            <th>API키</th>
            <th>카테고리</th>
            <th>중개수수료율</th>
            <th>중개수수료</th>
            <th>계약상태</th>
            <th>등록일</th>
            <th>수정일</th>
            <th>종료일</th>
        </tr>
        </thead>
        <tbody id="resultTable"></tbody>
    </table>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>

<script th:inline="javascript">
    const loginMember = /*[[${session.loginMember}]]*/ null;
    let remainingTime = /*[[${session.sessionTimeout}]]*/ 1800;

    if (!loginMember) {
        alert("로그인 후 이용 가능합니다.");
        window.location.href = "/auth/login";
    } else if (loginMember.userTyp != 2) {
        alert("관리자만 접근 가능합니다.");
        window.location.href = "/auth/login";
    } else {
        document.getElementById("loginUserName").textContent = loginMember.nm + " (" + loginMember.id + ")";
    }

    function startCountdown() {
        const timerElement = document.getElementById("session-timer");
        const interval = setInterval(() => {
            if (remainingTime <= 0) {
                clearInterval(interval);
                alert("세션이 만료되었습니다. 다시 로그인해주세요.");
                window.location.href = "/auth/logout";
            } else {
                const minutes = Math.floor(remainingTime / 60);
                const seconds = remainingTime % 60;
                timerElement.textContent = minutes + "분 " + seconds + "초";
                remainingTime--;
            }
        }, 1000);
    }
    window.onload = startCountdown;

    let table;

    window.addEventListener('DOMContentLoaded', () => {
        // 시작 날짜를 2025년 1월 1일로 고정
        document.getElementById('startDate').value = '2025-01-01';

        // 종료 날짜는 그대로 현재 날짜로 유지
        const today = new Date();
        const formatDate = (date) => date.toISOString().slice(0, 10);
        document.getElementById('endDate').value = formatDate(today);

        fetch('/merchant/categories')
            .then(res => res.json())
            .then(data => {
                const categorySelect = document.getElementById('categorySelect');
                categorySelect.innerHTML = `<option value="">전체</option>`;
                data.forEach(cat => categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`);
            });

        searchMerchants();
    });

    document.getElementById('searchBtn').addEventListener('click', searchMerchants);
    document.getElementById('resetBtn').addEventListener('click', () => {
        // 초기화 시 시작 날짜를 2025년 1월 1일로 고정
        document.getElementById('startDate').value = '2025-01-01';

        // 초기화 시 종료 날짜를 현재 날짜로 설정
        const today = new Date();
        const formatDate = (date) => date.toISOString().slice(0, 10);
        document.getElementById('endDate').value = formatDate(today);

        document.getElementById('categorySelect').value = '';
        document.getElementById('merchantNm').value = '';
        document.getElementById('businessNum').value = '';
        document.getElementById('contractStatus').value = '';
        searchMerchants();
    });

    function searchMerchants() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const categoryCd = document.getElementById('categorySelect').value;
        const merchantNm = document.getElementById('merchantNm').value;
        const businessNum = document.getElementById('businessNum').value;
        const contractStatus = document.getElementById('contractStatus').value;

        const params = new URLSearchParams();
        if (categoryCd) params.append('categoryCd', categoryCd);
        if (startDate) params.append('startDate', startDate);
        if (endDate) params.append('endDate', endDate);
        if (merchantNm) params.append('merchantNm', merchantNm);
        if (businessNum) params.append('businessNum', businessNum);
        if (contractStatus) params.append('contractStatus', contractStatus);

        fetch('/merchant/api/search?' + params.toString())
            .then(res => {
                if (!res.ok) {
                    throw new Error('Network response was not ok');
                }
                return res.json();
            })
            .then(data => {
                if ($.fn.DataTable.isDataTable('#example')) {
                    table.clear().rows.add(data).draw();
                } else {
                    table = $('#example').DataTable({
                        pageLength: 10,
                        lengthMenu: [10, 15, 20],
                        lengthChange: true,
                        dom: 'lrtip',
                        language: {
                            search: "검색:",
                            info: "총 _TOTAL_개 중 _START_–_END_",
                            infoEmpty: "0개",
                            zeroRecords: "결과가 없습니다"
                        },
                        paging: true,
                        pagingType: 'simple',
                        data: data,
                        columns: [
                            { data: 'merchantNum' },
                            { data: 'merchantNm' },
                            { data: 'businessNum' },
                            { data: 'apiKey' },
                            { data: 'categoryCd' },
                            { data: 'brokerageRate' },
                            { data: 'brokerage' },
                            { data: 'contractStatus' },
                            {
                                data: 'regDateTime',
                                render: function(data) {
                                    if (data) {
                                        const date = new Date(data);
                                        const year = date.getFullYear();
                                        const month = String(date.getMonth() + 1).padStart(2, '0');
                                        const day = String(date.getDate()).padStart(2, '0');
                                        const hours = String(date.getHours()).padStart(2, '0');
                                        const minutes = String(date.getMinutes()).padStart(2, '0');
                                        const seconds = String(date.getSeconds()).padStart(2, '0');
                                        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                                    }
                                    return '';
                                }
                            },
                            {
                                data: 'modifyDateTime',
                                render: function(data) {
                                    if (data) {
                                        const date = new Date(data);
                                        const year = date.getFullYear();
                                        const month = String(date.getMonth() + 1).padStart(2, '0');
                                        const day = String(date.getDate()).padStart(2, '0');
                                        const hours = String(date.getHours()).padStart(2, '0');
                                        const minutes = String(date.getMinutes()).padStart(2, '0');
                                        const seconds = String(date.getSeconds()).padStart(2, '0');
                                        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                                    }
                                    return '';
                                }
                            },
                            {
                                data: 'endDateTime',
                                render: function(data) {
                                    if (data) {
                                        const date = new Date(data);
                                        const year = date.getFullYear();
                                        const month = String(date.getMonth() + 1).padStart(2, '0');
                                        const day = String(date.getDate()).padStart(2, '0');
                                        const hours = String(date.getHours()).padStart(2, '0');
                                        const minutes = String(date.getMinutes()).padStart(2, '0');
                                        const seconds = String(date.getSeconds()).padStart(2, '0');
                                        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                                    }
                                    return '';
                                }
                            }
                        ],
                        drawCallback: function(settings) {
                            var api = this.api();
                            var pageInfo = api.page.info();

                            const currentPage = pageInfo.pages === 0 ? 1 : pageInfo.page + 1;
                            const totalPages = pageInfo.pages === 0 ? 1 : pageInfo.pages;

                            $('#example_paginate').html(`
                                <div class="flex items-center justify-center gap-2 mt-4">
                                    <button id="prevPage" class="px-3 py-1 rounded bg-blue-500 text-white hover:bg-blue-600 disabled:bg-gray-300" ${pageInfo.page === 0 ? 'disabled' : ''}>이전</button>
                                    <span class="font-semibold text-gray-700">${currentPage} / ${totalPages}</span>
                                    <button id="nextPage" class="px-3 py-1 rounded bg-blue-500 text-white hover:bg-blue-600 disabled:bg-gray-300" ${pageInfo.page + 1 === pageInfo.pages ? 'disabled' : ''}>다음</button>
                                </div>
                            `);

                            $('#prevPage').off('click').on('click', () => api.page('previous').draw('page'));
                            $('#nextPage').off('click').on('click', () => api.page('next').draw('page'));
                        }
                    });
                }
            })
            .catch(error => console.error('Error fetching merchants:', error));
    }
</script>

</body>
</html>