<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>이용내역</title>

    <style>
        :root {
            --primary: #2196f3;
            --primary-glow: rgba(33, 150, 243, 0.4);
            --background: #0a0a12;
            --surface: rgba(30, 30, 45, 0.95);
            --surface-hover: rgba(40, 40, 60, 0.95);
            --text: #ffffff;
            --border: rgba(255, 255, 255, 0.1);
            --shadow: rgba(0, 0, 0, 0.3);
            --glow: 0 0 10px var(--primary-glow);
            --glass: saturate(180%) blur(10px);
            --gradient: linear-gradient(135deg, var(--surface), rgba(40, 40, 60, 0.95));
            --transition-medium: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --border-radius: 8px;
        }

        html, body {
            height: 100%;
            margin: 0;
        }

        /* 페이지 전체 그라데이션 유지 */
        body {
            min-height: 100vh;
            background: linear-gradient(180deg, #EDFAFF 0%, #F0FFF5 100%);
        }

        /* 테이블/컨테이너의 배경은 투명 처리 */
        .container, table, #example_wrapper {
            background-color: transparent !important;
        }

        #example th, #example td {
            text-align: center;
            vertical-align: middle;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ccc;
        }
        .topbar span { font-weight: bold; font-size: 1rem; }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css"/>
</head>
<body class="bg-gray-50">

<div class="topbar">
    <span id="loginUserName"></span>
    <span>남은 세션 시간: <span id="session-timer"></span></span>
</div>

<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h2 class="text-2xl font-bold mb-4">이용내역</h2>

    <div id="custom-toolbar" class="flex flex-col sm:flex-row items-center justify-center gap-3 mb-6">
        <label for="categorySelect">카테고리:</label>
        <select id="categorySelect" class="border border-gray-300 rounded-xl px-3 py-2 bg-white"></select>

        <label for="merchantSelect">가맹점:</label>
        <select id="merchantSelect" class="border border-gray-300 rounded-xl px-3 py-2 bg-white"></select>

        <label for="startDate">시작일:</label>
        <input type="date" id="startDate" class="border border-gray-300 rounded-xl px-3 py-2 bg-white">

        <label for="endDate">종료일:</label>
        <input type="date" id="endDate" class="border border-gray-300 rounded-xl px-3 py-2 bg-white">

        <button id="searchBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700">검색</button>
        <button id="resetBtn" class="px-4 py-2 rounded-xl bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300">초기화</button>
    </div>

    <table id="example" class="table-auto w-full">
        <thead>
        <tr>
            <th>거래번호</th>
            <th>회원번호</th>
            <th>전화번호</th>
            <th>카테고리</th>
            <th>가맹점번호</th>
            <th>사용금액</th>
            <th>결제일자</th>
            <th>예약상태</th>
            <th>수정</th>
        </tr>
        </thead>
        <tbody id="resultTable"></tbody>
    </table>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>

<script th:inline="javascript">
    // 세션 기반 로그인 정보
    const loginMember = /*[[${session.loginMember}]]*/ null;
    let remainingTime = /*[[${session.sessionTimeout}]]*/ 1800;

    if (!loginMember) {
        alert("로그인 후 이용 가능합니다.");
        window.location.href = "/auth/login";
    } else if (loginMember.userTyp != 2) {
        alert("관리자만 접근 가능합니다.");
        window.location.href = "/auth/login";
    } else {
        document.getElementById("loginUserName").textContent = loginMember.nm + " (" + loginMember.id + ")";
    }

    function startCountdown() {
        const timerElement = document.getElementById("session-timer");
        const interval = setInterval(() => {
            if (remainingTime <= 0) {
                clearInterval(interval);
                alert("세션이 만료되었습니다. 다시 로그인해주세요.");
                window.location.href = "/auth/logout";
            } else {
                const minutes = Math.floor(remainingTime / 60);
                const seconds = remainingTime % 60;
                timerElement.textContent = minutes + "분 " + seconds + "초";
                remainingTime--;
            }
        }, 1000);
    }
    window.onload = startCountdown;

    let allMerchants = [];
    let table;

    window.addEventListener('DOMContentLoaded', () => {
        // 오늘 기준 날짜 계산
        const today = new Date();
        const sixMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 6, today.getDate());

        // 날짜 필드 초기값 설정
        document.getElementById('startDate').valueAsDate = sixMonthsAgo;
        document.getElementById('endDate').valueAsDate = today;

        // 카테고리 조회
        fetch('/usehistory/categories')
            .then(res => res.json())
            .then(data => {
                const categorySelect = document.getElementById('categorySelect');
                categorySelect.innerHTML = `<option value="">전체</option>`;
                data.forEach(cat => categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`);
            });

        // 가맹점 조회
        fetch('/usehistory/merchants')
            .then(res => res.json())
            .then(data => {
                allMerchants = data;
                updateMerchantSelect();
                searchUseHistory(); // 초기 조회
            });

        table = $('#example').DataTable({
            pageLength: 10,         // 기본 페이지당 10개
            lengthMenu: [10, 15, 20], // 사용자가 선택할 수 있는 옵션
            lengthChange: true,     // 페이지당 항목 수 변경 가능
            dom: 'lrtip',
            language: {
                search: "검색:",
                info: "총 _TOTAL_개 중 _START_–_END_",
                infoEmpty: "0개",
                zeroRecords: "결과가 없습니다"
            },
            paging: true,
            pagingType: 'simple',
            drawCallback: function(settings) {
                var api = this.api();
                var pageInfo = api.page.info();

                const currentPage = pageInfo.pages === 0 ? 1 : pageInfo.page + 1;
                const totalPages = pageInfo.pages === 0 ? 1 : pageInfo.pages;

                $('#example_paginate').html(`
            <div class="flex items-center justify-center gap-2 mt-4">
                <button id="prevPage" class="px-3 py-1 rounded bg-blue-500 text-white hover:bg-blue-600 disabled:bg-gray-300" ${pageInfo.page === 0 ? 'disabled' : ''}>이전</button>
                <span class="font-semibold text-gray-700">${currentPage} / ${totalPages}</span>
                <button id="nextPage" class="px-3 py-1 rounded bg-blue-500 text-white hover:bg-blue-600 disabled:bg-gray-300" ${pageInfo.page + 1 === pageInfo.pages ? 'disabled' : ''}>다음</button>
            </div>
        `);

                $('#prevPage').off('click').on('click', () => api.page('previous').draw('page'));
                $('#nextPage').off('click').on('click', () => api.page('next').draw('page'));
            }
        });

    });

    document.getElementById('categorySelect').addEventListener('change', updateMerchantSelect);

    function updateMerchantSelect() {
        const categoryCd = document.getElementById('categorySelect').value;
        const merchantSelect = document.getElementById('merchantSelect');
        merchantSelect.innerHTML = `<option value="">전체</option>`;
        const filtered = categoryCd ? allMerchants.filter(m => m.categoryCd === categoryCd) : allMerchants;
        filtered.forEach(m => merchantSelect.innerHTML += `<option value="${m.merchantNum}">${m.merchantNm}</option>`);
    }

    document.getElementById('searchBtn').addEventListener('click', searchUseHistory);

    function searchUseHistory() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const categoryCd = document.getElementById('categorySelect').value;
        const merchantNum = document.getElementById('merchantSelect').value;

        const params = new URLSearchParams();
        if (categoryCd) params.append('categoryCd', categoryCd);
        if (merchantNum) params.append('merchantNum', merchantNum);
        if (startDate) params.append('startDate', startDate);
        if (endDate) params.append('endDate', endDate);

        fetch('/usehistory/list?' + params)
            .then(res => res.json())
            .then(data => {
                const table = $('#example').DataTable();
                table.clear();
                data.forEach(item => {
                    table.row.add([
                        item.transactionNum,
                        item.memberNum,
                        item.phoneNum,
                        item.categoryCd,
                        item.merchantNum,
                        item.brokerage || '',
                        item.paymentDateTime || '',
                        item.reservationStatus,
                        `<button class="px-2 py-1 bg-blue-500 text-white rounded">수정</button>`
                    ]);
                });
                table.draw();
            });
    }

    document.getElementById('resetBtn').addEventListener('click', () => {
        const today = new Date();
        const sixMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 6, today.getDate());

        document.getElementById('startDate').valueAsDate = sixMonthsAgo;
        document.getElementById('endDate').valueAsDate = today;
        document.getElementById('categorySelect').value = '';
        document.getElementById('merchantSelect').value = '';
        searchUseHistory(); // 초기 조회 다시 수행
    });
</script>

</body>
</html>
