<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>SB Admin 2 - Dashboard</title>

    <!-- Custom fonts for this template-->
    <link href="/bootstrap/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="/bootstrap/css/sb-admin-2.min.css" rel="stylesheet">

    <!--메뉴바 css-->
    <link rel="stylesheet" th:href="@{/css/style.css}"/>

    <style>
        .select-box {
              position: relative;
              display: block;
              width: 50%;
              font-family: 'Open Sans', 'Helvetica Neue', 'Segoe UI', 'Calibri', 'Arial', sans-serif;
              font-size: 18px;
              color: #60666d;
              margin-left: auto;
              padding-right: 30px;
            z-index: 1000;
          }

        @media (min-width: 768px) {
            .select-box {
                width: 70%;
            }
        }

        @media (min-width: 992px) {
            .select-box {
                width: 50%;
            }
        }

        @media (min-width: 1200px) {
            .select-box {
                width: 30%;
            }
        }

        .select-box__current {
            position: relative;
            box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            outline: none;
        }

        .select-box__current:focus + .select-box__list {
            opacity: 1;
            animation-name: none;
        }

        .select-box__current:focus + .select-box__list .select-box__option {
            cursor: pointer;
        }

        .select-box__current:focus .select-box__icon {
            transform: translateY(-50%) rotate(180deg);
        }

        .select-box__icon {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            width: 20px;
            opacity: 0.3;
            transition: 0.2s ease;
        }

        .select-box__value {
            display: flex;
        }

        .select-box__input {
            display: none;
        }

        .select-box__input:checked + .select-box__input-text {
            display: block;
        }

        .select-box__input-text {
            display: none;
            width: 100%;
            margin: 0;
            padding: 15px;
            background-color: #fff;
        }

        .select-box__list {
            position: absolute;
            width: 100%;
            padding: 0;
            list-style: none;
            opacity: 0;
            animation-name: HideList;
            animation-duration: 0.5s;
            animation-delay: 0.5s;
            animation-fill-mode: forwards;
            animation-timing-function: step-start;
            box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.1);
        }

        .select-box__option {
            display: block;
            padding: 15px;
            background-color: #fff;
        }

        .select-box__option:hover,
        .select-box__option:focus {
            color: #546c84;
            background-color: #fbfbfb;
        }

        @keyframes HideList {
            from {
                transform: scaleY(1);
            }
            to {
                transform: scaleY(0);
            }
        }
    </style>
</head>

<body class="bg-gray-50" id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- Main Content -->
            <div id="content">

                <!--topbar start-->
                <div class="topbar">
                    <!-- 왼쪽: 로고 (대쉬보드로 이동) -->
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <a href="/dashboard/dashboardSelect">
                            <img src="/img/KakaoTalk_20250923_163110071.png" alt="로고" style="height: 30px; cursor: pointer;">
                        </a>
                    </div>

                    <div class="select-box">
                        <div class="select-box__current" tabindex="1">
                            <div class="select-box__value">
                                <input class="select-box__input" type="radio" id="1" value="1" name="Ben" checked="checked">
                                <p class="select-box__input-text">3초</p>
                            </div>
                            <div class="select-box__value">
                                <input class="select-box__input" type="radio" id="2" value="2" name="Ben">
                                <p class="select-box__input-text">10초</p>
                            </div>
                            <div class="select-box__value">
                                <input class="select-box__input" type="radio" id="3" value="3" name="Ben">
                                <p class="select-box__input-text">30초</p>
                            </div>
                            <div class="select-box__value">
                                <input class="select-box__input" type="radio" id="4" value="4" name="Ben">
                                <p class="select-box__input-text">새로고침 주기 없음</p>
                            </div>
                            <img class="select-box__icon" src="http://cdn.onlinewebfonts.com/svg/img_295694.svg" alt="Arrow Icon" aria-hidden="true">
                        </div>
                        <ul class="select-box__list">
                            <li><label class="select-box__option" for="1" aria-hidden="true">3초</label></li>
                            <li><label class="select-box__option" for="2" aria-hidden="true">10초</label></li>
                            <li><label class="select-box__option" for="3" aria-hidden="true">30초</label></li>
                            <li><label class="select-box__option" for="4" aria-hidden="true">새로고침 주기 없음</label></li>
                        </ul>
                    </div>

                    <!-- 오른쪽: 관리자 이름 + 세션 시간 -->
                    <div style="display: flex; flex-direction: column; align-items: flex-end; line-height: 1.4;">
                        <span id="loginUserName" style="color: black; font-size: 14px; font-weight: bold;"></span>
                        <span style="color: black; font-size: 12px;">
            남은 세션 시간: <span id="session-timer"></span>
                        </span>
                    </div>
                </div>

                <!--topbar end-->


                <!-- Begin Page Content -->
                <div class="container-fluid dashboard-wrapper" style="padding-top: 8px">

                    <div class="row">

                        <!-- Earnings (Monthly) Card Example -->
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-primary shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                회원수</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalMembersCard" th:text="${totalMembers}"></div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-user fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Earnings (Monthly) Card Example -->
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-success shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                가맹점수</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalMerchantsCard" th:text="${totalMerchants}"></div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-store fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Earnings (Monthly) Card Example -->
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-info shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">외부 API 요청건수
                                            </div>
                                            <div class="row no-gutters align-items-center">
                                                <div class="col-auto">
                                                    <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800"  id="externalApiCallCard"  th:text="${externalApiCallCount}"></div>
                                                </div>
                                                <!--                                                <div class="col">-->
                                                <!--                                                    <div class="progress progress-sm mr-2">-->
                                                <!--                                                        <div class="progress-bar bg-info" role="progressbar"-->
                                                <!--                                                            style="width: 50%" aria-valuenow="50" aria-valuemin="0"-->
                                                <!--                                                            aria-valuemax="100"></div>-->
                                                <!--                                                    </div>-->
                                                <!--                                                </div>-->
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-list fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pending Requests Card Example -->
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-warning shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                                H/G 처리건수</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="gatewayProcessCard"  th:text="${gatewayProcessCount}"></div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- 바 그래프 1 (4) -->
                        <div class="col-xl-4 col-lg-6 mb-4">
                            <div class="card border-left-success shadow h-70 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                거래금액 (금일)</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800">15,000원</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                    <div class="chart-bar">
                                        <canvas id="myBarChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 바 그래프 2 (4) -->
                        <div class="col-xl-4 col-lg-6 mb-4">
                            <div class="card border-left-success shadow h-70 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                거래금액 (금월)</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800">361,000원</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                    <div class="chart-bar">
                                        <canvas id="myBarChart2"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-4 col-lg-12">
                            <div class="card shadow mb-4 "> <!-- ✅ 흰색 박스 -->
                                <div class="card-body">
                                    <div class="row justify-content-center text-center" style="height: 330px">
                                        <div class="col-md-4" style="padding-top: 42px">
                                            <div class="card text-white shadow mb-4" id="PUB"><div class="card-body">공공 API</div></div>
                                            <div class="card text-white shadow mb-4" style="margin-top: 120px" id="AI0"><div class="card-body">Chat GPT</div></div>
                                        </div>
                                        <div class="col-md-4 d-flex align-items-center justify-content-center">
                                            <div class="card bg-primary text-white shadow w-100">
                                                <div class="card-body">H/G</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4" style="padding-top: 42px">
                                            <div class="card text-white shadow mb-4"><div class="card-body" id="B01">따릉이</div></div>
                                            <div class="card text-white shadow mb-4" style="margin-top: 120px" id="T01"><div class="card-body">여행사</div></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Content Row -->
                    <div class="row">

                        <!-- Area Chart -->
                        <div class="col-12">
                            <div class="card shadow mb-4">
                                <!-- Card Body -->
                                <div class="card-body">
                                    <div class="chart-area">
                                        <canvas id="myAreaChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- /.container-fluid -->
            </div>

        </div>
        <!-- End of Content Wrapper -->

    <!-- End of Page Wrapper -->
    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>


        <div class="dropdown-wrapper">
            <button class="dropdown-trigger">
                <div class="icon"></div>
            </button>
            <div class="dropdown-menu">
                <div class="dropdown-item" data-href="/dashboard/dashboardSelect" onclick="location.href='/dashboard/dashboardSelect'">
                    <span>대시보드</span>
                </div>
                <div class="dropdown-item" data-href="/statistics/statisticsSelect" onclick="location.href='/statistics/statisticsSelect'">
                    <span>통계</span>
                </div>
                <div class="dropdown-item" data-href="/usehistory/usehistorySelect" onclick="location.href='/usehistory/usehistorySelect'">
                    <span>이용내역</span>
                </div>
                <div class="dropdown-item" data-href="/merchant/merchantSelect" onclick="location.href='/merchant/merchantSelect'">
                    <span>가맹점관리</span>
                </div>
                <div class="dropdown-item" data-href="/member/memberSelect" onclick="location.href='/member/memberSelect'">
                    <span>개인회원관리</span>
                </div>
                <div class="dropdown-divider"></div>
                <div class="dropdown-item" onclick="location.href='/auth/logout'">
                    <span>로그아웃</span>
                </div>
            </div>
        </div>



    <!-- Bootstrap core JavaScript-->
    <script src="/bootstrap/vendor/jquery/jquery.min.js"></script>
    <script src="/bootstrap/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="/bootstrap/vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="/bootstrap/js/sb-admin-2.min.js"></script>

    <!-- Page level plugins -->
    <script src="/bootstrap/vendor/chart.js/Chart.min.js"></script>

    <!-- Page level custom scripts -->
    <script src="/bootstrap/js/demo/chart-area-demo.js"></script>
    <script src="/bootstrap/js/demo/chart-area-demo2.js"></script>
    <script src="/bootstrap/js/demo/chart-pie-demo.js"></script>
    <script src="/bootstrap/js/demo/chart-bar-demo.js"></script>
    <script src="/bootstrap/js/demo/chart-bar-demo2.js"></script>

        <script>
            let refreshTimer = null;
            const STORAGE_KEY = 'refreshInterval';

            // 새로고침 interval 적용 함수
            function applyRefreshInterval(interval) {
                if (refreshTimer) clearInterval(refreshTimer);
                if (interval > 0) {
                    refreshTimer = setInterval(() => location.reload(), interval);
                }
            }

            document.addEventListener('DOMContentLoaded', () => {
                const box = document.querySelector('.select-box');
                const current = box.querySelector('.select-box__current');
                const inputs = box.querySelectorAll('.select-box__input');
                const texts = box.querySelectorAll('.select-box__input-text');

                // 열고 닫기
                current.addEventListener('click', () => {
                    box.classList.toggle('open');
                });

                // 옵션 선택 시
                inputs.forEach((input, i) => {
                    input.addEventListener('change', () => {
                        // 텍스트 갱신
                        texts.forEach(t => (t.style.display = 'none'));
                        texts[i].style.display = 'block';
                        box.classList.remove('open');

                        // 선택값 저장 + 새로고침 적용
                        let interval = 0;
                        switch (input.value) {
                            case '1': interval = 3000; break;   // 3초
                            case '2': interval = 10000; break;  // 10초
                            case '3': interval = 30000; break;  // 30초
                            case '4': interval = 0; break;      // 없음
                        }
                        localStorage.setItem(STORAGE_KEY, interval);
                        applyRefreshInterval(interval);
                    });
                });

                // 초기 선택 처리
                texts.forEach((t, i) => {
                    if (!inputs[i].checked) t.style.display = 'none';
                });

                // 저장된 값 복원
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved !== null) {
                    applyRefreshInterval(parseInt(saved, 10));
                    // 체크박스 상태 맞추기
                    let targetInput = null;
                    switch (saved) {
                        case '3000': targetInput = inputs[0]; break;
                        case '10000': targetInput = inputs[1]; break;
                        case '30000': targetInput = inputs[2]; break;
                        case '0': targetInput = inputs[3]; break;
                    }
                    if (targetInput) {
                        targetInput.checked = true;
                        texts.forEach(t => (t.style.display = 'none'));
                        targetInput.nextElementSibling.style.display = 'block';
                    }
                }
            });

        </script>
        <script>
            async function loadStatus() {
                try {
                    const res = await fetch("/api/dashboard/status");
                    const data = await res.json();

                    data.forEach(item => {
                        const box = document.getElementById(item.category_cd);
                        if (box) {
                            // 기존 색상 초기화
                            box.classList.remove("bg-warning", "bg-danger", "bg-success");

                            // 상태에 따라 색상 변경
                            if (item.status === "Y") {
                                box.classList.add("bg-warning");
                            } else {
                                box.classList.add("bg-danger");
                            }
                        }
                    });
                } catch (err) {
                    console.error("상태 불러오기 실패:", err);
                }
            }

            window.addEventListener("DOMContentLoaded", loadStatus);

        </script>

        <script th:inline="javascript">
        const loginMember = /*[[${session.loginMember}]]*/ null;
        let remainingTime = /*[[${session.sessionTimeout}]]*/ 1800;

        if (!loginMember) {
            alert("로그인 후 이용 가능합니다.");
            window.location.href = "/auth/login";
        } else if (loginMember.userTyp != 2) {
            alert("관리자만 접근 가능합니다.");
            window.location.href = "/auth/login";
        } else {
            document.getElementById("loginUserName").textContent = loginMember.nm + " (" + loginMember.id + ")";
        }

        function startCountdown() {
            const timerElement = document.getElementById("session-timer");
            const interval = setInterval(() => {
                if (remainingTime <= 0) {
                    clearInterval(interval);
                    alert("세션이 만료되었습니다. 다시 로그인해주세요.");
                    window.location.href = "/auth/logout";
                } else {
                    const minutes = Math.floor(remainingTime / 60);
                    const seconds = remainingTime % 60;
                    timerElement.textContent = minutes + "분 " + seconds + "초";
                    remainingTime--;
                }
            }, 1000);
        }
        window.onload = startCountdown;
    </script>
    <!--메뉴바 js-->
    <script th:src="@{/js/script.js}"></script>
</body>

</html>