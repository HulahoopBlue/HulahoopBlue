<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HulaHoopBlue</title>
    <link rel="stylesheet" href="css/blueApplication.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script th:src="@{//dapi.kakao.com/v2/maps/sdk.js(appkey=${kakaoApikey})}"></script>
    <script src="https://nsp.pay.naver.com/sdk/js/naverpay.min.js"></script>
</head>

<body>
    <div class="chat-container">
        <div class="notification" id="notification">HulaHoopBlue</div>

        <div class="chat-header">
            <div class="header-left">
                <button id="menuBtn">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>

            <div class="header-center">
                <p>HulaHoopBlue</p>
                <div class="user-info">
                    <p th:text="${loginMember.id}">ì•„ì´ë””</p>
                    <p th:text="${loginMember.phoneNum}">ì „í™”ë²ˆí˜¸</p>
                    <p th:text="${loginMember.memberNum}">íšŒì›ë²ˆí˜¸</p>
                    <p th:text="${loginMember.nm}">ì´ë¦„</p>
                    <p>ë‚¨ì€ ì„¸ì…˜ ì‹œê°„: <span id="session-timer"></span></p>
                </div>
            </div>

            <div class="header-right">
                <div class="avatar">
                    <img src="https://images.unsplash.com/photo-1573497019940-1c28c88b4f3e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=100&q=80" alt="Support Agent">
                </div>
            </div>

        </div>
        <div class="nav--open" id="hhNav">
            <div class="nav-header">
                <div class="nav--open-title">HulaHoopBlue</div>
                <div class="nav--open-icon" id="hhClose"><i class="fas fa-times"></i></div>
            </div>
            <div class="nav--open-menu">
                <a th:href="@{/useHistory(reservation_status='N')}">ì´ìš©ë‚´ì—­</a>
                <a th:href="@{/useHistory(reservation_status='Y')}">ì˜ˆì•½ë‚´ì—­</a>
                <a th:href="@{/useHistory(reservation_status='C')}">ì·¨ì†Œë‚´ì—­</a>
                <a href="javascript:alert('ì´ìš©ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.')">ë©”ì„¸ì§€í•¨</a>


                <a th:href="@{member/mypage}">ì„¤ì •</a>
            </div>
        </div>

        <div class="chat-body custom-scroll" id="chat-body">

        </div>
        <div class="message1">
            <div class="typing-indicator" id="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        <div class="quick-replies custom-scroll">
            <div class="quick-reply-box">
                <button class="quick-reply">ë„ì›€ë§</button>
            </div>
        </div>

        <div class="chat-footer">
            <div class="input-container">
                <input type="text" class="input-field" id="message-input" placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”...">
                <div class="quick-actions">
                    <button class="quick-action"><i class="fas fa-solid fa-microphone"></i></button>
                </div>
            </div>

            <button class="send-button" id="send-button">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatBody = document.getElementById('chat-body');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const typingIndicator = document.getElementById('typing-indicator');
            const quickReplyButtons = document.querySelectorAll('.quick-reply');

            // ì¹´ë“œ ëˆ„ì  ì¹´ìš´í„°
            let bikeCardCount = 0;

            if (typingIndicator) typingIndicator.style.display = 'none';

            const fmtTime = (d = new Date()) => {
                let h = d.getHours();
                const m = String(d.getMinutes()).padStart(2, '0');
                const ap = h >= 12 ? 'PM' : 'AM';
                h = h % 12 || 12;
                return `${h}:${m} ${ap}`;
            };

            function addMessage({ text = '', html = '', role = 'agent' } = {}) {
                if (!text && !html) return;
                const wrap = document.createElement('div');
                wrap.className = `message ${role}`;

                const content = document.createElement('div');
                if (html) content.innerHTML = html;
                else content.textContent = text;

                const time = document.createElement('div');
                time.className = 'time';
                time.textContent = fmtTime();

                // ì‚¬ìš©ì ë©”ì‹œì§€ì¼ ë•Œ ì²´í¬ ì•„ì´ì½˜ ì¶”ê°€
                if (role === 'user') {
                    const statusSpan = document.createElement('span');
                    statusSpan.className = 'message-status';
                    statusSpan.innerHTML = ' <i class="fas fa-check-double"></i>'; // ì•ì— ê³µë°±
                    time.appendChild(statusSpan);
                }

                wrap.appendChild(content);
                wrap.appendChild(time);
                chatBody.appendChild(wrap);
                chatBody.scrollTop = chatBody.scrollHeight;
                return wrap;
            }

            function addBotMessage(htmlOrText) {
                if (typeof htmlOrText === 'string' && htmlOrText.includes('<')) {
                    addMessage({ html: htmlOrText, role: 'agent' });
                } else {
                    addMessage({ text: String(htmlOrText), role: 'agent' });
                }
            }

            function addUserMessage(text) {
                addMessage({ text, role: 'user' });
            }

            function addAgentResponse(text, delay = 2000) {
                if (typingIndicator) typingIndicator.style.display = 'flex';
                chatBody.scrollTop = chatBody.scrollHeight;
                setTimeout(() => {
                    if (typingIndicator) typingIndicator.style.display = 'none';
                    addBotMessage(text);
                }, delay);
            }

            async function sendMessage() {
                const msg = (messageInput && messageInput.value || '').trim();
                if (!msg) {
                    alert('ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                addUserMessage(msg);
                if (messageInput) messageInput.value = '';

                (async () => {
                    try {
                        const SERVER_API_URL = '/api/generate';
                        await fetch(SERVER_API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: msg })
                        }).catch(() => {});
                    } catch (e) {
                        console.warn('ì„œë²„ í˜¸ì¶œ ì‹¤íŒ¨(ë¬´ì‹œ):', e);
                    }
                })();

                if (msg.includes('ìì „ê±°') || msg.includes('ì—¬í–‰ì‚¬')) {
                    if (typeof window.showProduct === 'function') {
                        let productType = '';

                        if (msg.includes('ìì „ê±°')) {
                            productType = 'B';
                        } else if (msg.includes('ì—¬í–‰ì‚¬')) {
                            productType = 'T';
                        }
                        else {
                            addAgentResponse('ì§€ì›í•˜ì§€ ì•ŠëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.<br> ì˜ˆ) ìì „ê±°, ì—¬í–‰ì‚¬');
                            return;
                        }

                        window.showProduct(productType);
                        addAgentResponse('ì˜ˆì•½ ì§„í–‰ì¤‘ì…ë‹ˆë‹¤.<br> ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                    } else {
                        addAgentResponse('ì˜ˆì•½ ê¸°ëŠ¥ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    return;
                }

                if (msg.toLowerCase().includes('hi') || msg.toLowerCase().includes('hello')) {
                    addAgentResponse('ì˜ˆì•½í•˜ì‹œê³  ì‹¶ì€ ê²ƒì„ ë§í•´ì£¼ì‹œë©´ ì˜ˆì•½ ì§„í–‰ì„ ë„ì™€ë“œë¦½ë‹ˆë‹¤.<br> ì˜ˆ) ìì „ê±°, ì—¬í–‰ì‚¬');
                } else {
                    addAgentResponse('ì˜ˆì•½í•˜ì‹œê³  ì‹¶ì€ ê²ƒì„ ì •í™•íˆ ë§í•´ì£¼ì„¸ìš”!');
                }
            }

            if (sendButton) sendButton.addEventListener('click', sendMessage);
            if (messageInput) messageInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

            quickReplyButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const txt = btn.textContent.trim();
                    addUserMessage(txt);
                    if (txt.includes('ë„ì›€ë§')) {
                        addAgentResponse('ì˜ˆì•½í•˜ì‹œê³  ì‹¶ì€ ê²ƒì„ ë§í•´ì£¼ì‹œë©´ ì˜ˆì•½ ì§„í–‰ì„ ë„ì™€ë“œë¦½ë‹ˆë‹¤.<br> ex) ìì „ê±°/ì—¬í–‰ì‚¬');
                    } else {
                        if (typeof window.showProduct === 'function') {
                            let productType = '';
                            if (txt.includes('ìì „ê±°')) {
                                productType = 'B';
                            } else if (txt.includes('ì—¬í–‰ì‚¬')) {
                                productType = 'T';
                            }
                            window.showProduct(productType);
                            addAgentResponse('ì˜ˆì•½ ì§„í–‰ì¤‘ì…ë‹ˆë‹¤!');
                        } else {
                            addAgentResponse('ì˜ˆì•½í•˜ì‹œê³  ì‹¶ì€ ê²ƒì„ ì •í™•íˆ ë§í•´ì£¼ì„¸ìš”!');
                        }
                    }
                });
            });

            setTimeout(() => addAgentResponse('ì•ˆë…•í•˜ì„¸ìš”!<br> ì˜ˆì•½í•˜ì‹œê³  ì‹¶ì€ ê²ƒì„ ë§í•´ì£¼ì„¸ìš”!'), 1);

            window.showProduct = function (productType) {
                bikeCardCount++;
                const uniq = Date.now() + '-' + bikeCardCount;

                if (!window.kakao || !kakao.maps) {
                    addBotMessage('ì¹´ì¹´ì˜¤ ë§µ ë¡œë“œ ì‹¤íŒ¨: Kakao SDKê°€ ë¡œë“œë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }

                const bubble = document.createElement('div');
                bubble.className = 'kakao map';
                const timeStr = fmtTime();
                bubble.innerHTML = `
                        <div class="product-preview">
                            <div class="bike-info" id="bike-info-${uniq}" style="width:100%; height:260px;"></div>
                            <div class="product-info">
                                <div class="product-name" id="product-name-${uniq}"></div>
                                <div class="product-price" id="bike-count-${uniq}">í˜„ì¬ ì‚¬ìš© ê°€ëŠ¥í•œ ìƒí’ˆ ìˆ˜: ë¡œë”©ì¤‘â€¦</div>
                                <div class="product-actions hidden">
                                    <button class="action-button add-button" id="add-to-cart-${uniq}" disabled>ì˜ˆì•½í•˜ê¸°</button>
                                    <button class="action-button pay-button" id="pay-button-${uniq}" disabled><i class="fas fa-shopping-cart"></i>ê²°ì œí•˜ê¸°</button>
                                </div>
                            </div>
                        </div>
                        <div class="time">${timeStr}</div>
                    `;
                chatBody.appendChild(bubble);
                chatBody.scrollTop = chatBody.scrollHeight;

                const infoBox = bubble.querySelector(`#bike-info-${uniq}`);
                const productName = bubble.querySelector(`#product-name-${uniq}`);
                const actionsDiv = bubble.querySelector('.product-actions');
                const reserveBtn = bubble.querySelector(`#add-to-cart-${uniq}`);
                const payBtn = bubble.querySelector(`#pay-button-${uniq}`);
                const countLabel = bubble.querySelector(`#bike-count-${uniq}`);

                const disableBtn = btn => {
                    if (btn) {
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                        btn.style.cursor = 'not-allowed';
                    }
                };
                const enableBtn = btn => {
                    if (btn) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    }
                };

                disableBtn(reserveBtn);
                disableBtn(payBtn);

                const map = new kakao.maps.Map(infoBox, {
                    center: new kakao.maps.LatLng(37.5630542, 127.1928256),
                    level: 3
                });

                let markerImage = '';

                if (productType == 'T') {
                    markerImage = new kakao.maps.MarkerImage(
                        "/img/airplane.png",
                        new kakao.maps.Size(20, 30)
                    );
                }
                else {
                    markerImage = new kakao.maps.MarkerImage(
                        "/img/bicycle.png",
                        new kakao.maps.Size(20, 30)
                    );
                }

                let lastSelected = null;
                const fmt = n => (typeof n === 'number' ? Number(n).toFixed(6) : n);

                fetch(`/markers?productType=${productType}`)
                    .then(r => {
                        if (!r.ok) throw new Error('ë§ˆì»¤ ë¡œë“œ ì‹¤íŒ¨: ' + r.status);
                        return r.json();
                    })
                    .then(list => {
                        if (!Array.isArray(list) || list.length === 0) {
                            countLabel.textContent = 'í˜„ì¬ ì‚¬ìš© ê°€ëŠ¥í•œ ìƒí’ˆ ìˆ˜: 0';
                            addBotMessage('í‘œì‹œí•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.');
                            return;
                        }

                        countLabel.textContent = `í˜„ì¬ ì‚¬ìš© ê°€ëŠ¥í•œ ìƒí’ˆ ìˆ˜: ${list.length}`;
                        const bounds = new kakao.maps.LatLngBounds();

                        list.forEach(pos => {
                            const lat = Number(pos.lat);
                            const lng = Number(pos.lng);
                            if (Number.isNaN(lat) || Number.isNaN(lng)) return;

                            const latlng = new kakao.maps.LatLng(lat, lng);
                            bounds.extend(latlng);

                            const marker = new kakao.maps.Marker({
                                map,
                                position: latlng,
                                image: markerImage
                            });

                            const infoHtml = `
                                    <div style="padding:4px; font-size:10px;">
                                        <strong>ê°€ë§¹ì ëª…: ${pos.merchantNm || 'ê¸°íƒ€'}</strong><br/>
                                        <strong>ìƒí’ˆ ìˆ˜: ${pos.cnt ?? pos.cnt ?? '-'}ëŒ€</strong>
                                    </div>
                                `;

                            const infowindow = new kakao.maps.InfoWindow({content: infoHtml});

                            kakao.maps.event.addListener(marker, 'mouseover', () => infowindow.open(map, marker));
                            kakao.maps.event.addListener(marker, 'mouseout', () => infowindow.close());

                            kakao.maps.event.addListener(marker, 'click', () => {
                                lastSelected = {
                                    categoryCd: pos.categoryCd || '-',
                                    productNum: pos.productNum || '-',
                                    merchantNum: pos.merchantNum || '-',
                                    merchantNm: pos.merchantNm || '-',
                                    lat,
                                    lng,
                                    raw: pos
                                };

                                actionsDiv.classList.remove('hidden');

                                productName.innerHTML = `ìƒí’ˆëª…: <b>${lastSelected.productNum}</b><br>ê°€ë§¹ì ëª…: <b>${lastSelected.merchantNm}</b>`;
                                enableBtn(reserveBtn);
                                enableBtn(payBtn);

                            });
                        });

                        try {
                            map.setBounds(bounds);
                        } catch (e) {
                            console.warn('map.setBounds ì‹¤íŒ¨:', e);
                        }
                    })
                    .catch(e => {
                        console.error(e);
                        countLabel.textContent = 'í˜„ì¬ ì‚¬ìš© ê°€ëŠ¥í•œ ìƒí’ˆ ìˆ˜: ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
                        addBotMessage('ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨.<br> ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                        return;
                    });

                reserveBtn.addEventListener('click', async () => {
                    if (!lastSelected) {
                        addBotMessage('ë¨¼ì € ì§€ë„ì˜ ìƒí’ˆì„ ì„ íƒí•´ ì£¼ì„¸ìš” ğŸ”');
                        return;
                    }

                    disableBtn(reserveBtn);
                    reserveBtn.textContent = 'ì˜ˆì•½í™•ì¸ì¤‘â€¦';
                    addBotMessage('ê²°ì œì²˜ë¦¬í›„ ì˜ˆì•½ ì™„ë£Œ ë©ë‹ˆë‹¤.<br> ê²°ì œí•˜ê¸° ì§„í–‰í•´ ì£¼ì„¸ìš”.<br> ì˜ˆì•½ ì§„í–‰ì¤‘ì…ë‹ˆë‹¤!');
                    enableBtn(payBtn);
                    reserveBtn.textContent = 'ì˜ˆì•½í•˜ê¸°';

                });

                var oPay = Naver.Pay.create({
                    "mode" : "development",
                    "clientId": "HN3GGCMDdTgGUfl0kFCo",
                    "chainId": "VlFlWlFJVzB2Z2t"
                });

                async function getFee(productNum, merchantNum) {
                    const res = await fetch('http://localhost:8001/payment/fee', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            id: productNum,
                            merchantNum: merchantNum
                        })
                    });

                    if (!res.ok) throw new Error('ê¸ˆì•¡ ì¡°íšŒ ì‹¤íŒ¨');
                    return await res.json();
                }

                async function pay() {
                    if (!lastSelected || !lastSelected.productNum || !lastSelected.merchantNum) {
                        addBotMessage('ë¨¼ì € ê²°ì œí•  ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    const productNum = lastSelected.productNum;
                    const merchantNum = lastSelected.merchantNum;

                    const fee = await getFee(productNum, merchantNum);
                    const purchaseNum = Date.now();

                    oPay.open({
                        "merchantPayKey": "TEST-" + purchaseNum,
                        "productName": "ìˆ˜ìˆ˜ë£Œ ê²°ì œ",
                        "productCount": "1",
                        "totalPayAmount": String(fee),
                        "taxScopeAmount": String(fee),
                        "taxExScopeAmount": "0",
                        "returnUrl": `http://localhost:8001/payment/return?clientId=${productNum}`
                    });

                    const payload = {
                        memberNum: '[[${loginMember.memberNum}]]',
                        phoneNum: '[[${loginMember.phoneNum}]]',
                        categoryCd: lastSelected.categoryCd,
                        merchantNum: lastSelected.merchantNum,
                        brokerage: fee,
                        reservationStatus: "Y"
                    };

                    try {
                        const res = await fetch('/reservations', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(payload)
                        });

                        if (!res.ok) throw new Error('HTTP ' + res.status);
                        const data = await res.json();

                    } catch (e) {
                        console.error(e);
                        addBotMessage('âŒ ì˜ˆì•½ ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì¤˜.');
                        enableBtn(reserveBtn);
                        reserveBtn.textContent = 'ì˜ˆì•½í•˜ê¸°';
                    }

                }
                payBtn.addEventListener('click', pay);
            };
        });

        let remainingTime = [[${remainingTime}]]; // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ì´ˆê¸° ì„¸ì…˜ ì‹œê°„ (ì´ˆ ë‹¨ìœ„)

        function startCountdown() {
            const timerElement = document.getElementById("session-timer");

            const interval = setInterval(() => {
                if (remainingTime <= 0) {
                    clearInterval(interval);
                    alert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                    window.location.href = "/logout";
                } else {
                    const minutes = Math.floor(remainingTime / 60);
                    const seconds = remainingTime % 60;
                    timerElement.textContent = minutes + "ë¶„ " + seconds + "ì´ˆ";
                    remainingTime--;
                }
            }, 1000);
        }

        window.onload = startCountdown;

        const nav = document.getElementById('hhNav');
        const btnOpen = document.getElementById('menuBtn');
        const btnClose = document.getElementById('hhClose');

        const openNav = () => nav.classList.add('open');
        const closeNav = () => nav.classList.remove('open');

        // ë§ˆìš°ìŠ¤ê°€ ë©”ë‰´ ë²„íŠ¼ì´ë‚˜ ë©”ë‰´ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ì— ìˆì„ ë•Œ ë©”ë‰´ê°€ ì—´ë¦¬ë„ë¡ ìˆ˜ì •
        let timeoutId;

        // ë©”ë‰´ ë²„íŠ¼ê³¼ ë©”ë‰´ ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        btnOpen.addEventListener('mouseenter', () => {
            clearTimeout(timeoutId);
            openNav();
        });

        nav.addEventListener('mouseenter', () => {
            clearTimeout(timeoutId);
        });

        btnOpen.addEventListener('mouseleave', () => {
            timeoutId = setTimeout(() => {
                closeNav();
            }, 300);
        });

        nav.addEventListener('mouseleave', () => {
            timeoutId = setTimeout(() => {
                closeNav();
            }, 300);
        });

        // ë‹«ê¸° ë²„íŠ¼ê³¼ ESC í‚¤ ê¸°ëŠ¥ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
        btnClose.addEventListener('click', closeNav);
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeNav();
            }
        });
    </script>
</body>
</html>