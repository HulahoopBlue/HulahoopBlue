<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hulahoopblue.blue.model.dao.UseHistoryMapper">

    <resultMap id="UseHistoryViewMap" type="com.hulahoopblue.blue.model.dto.UseHistoryViewDTO">
        <result column="merchant_nm" property="merchantNm"/>
        <result column="use_start_date_time" property="useStartDateTime"/>
        <result column="use_end_date_time" property="useEndDateTime"/>
        <result column="brokerage" property="brokerage"/>
    </resultMap>

    <select id="selectUseHistories" resultMap="UseHistoryViewMap">
        SELECT
        b.merchant_nm,
        a.use_start_date_time,
        a.use_end_date_time,
        b.brokerage
        FROM t_usehistory a
        JOIN t_merchant b ON a.merchant_num = b.merchant_num
        <where>
            <if test="memberNum != null and memberNum != ''">
                a.member_num = #{memberNum}
            </if>
            <if test="categoryCd != null and categoryCd != ''">
                AND b.category_cd LIKE CONCAT(#{categoryCd}, '%')
            </if>
            <if test="merchantNm != null and merchantNm != ''">
                AND b.merchant_nm = #{merchantNm}
            </if>
            <!-- 날짜 필터 추가 -->
            <if test="fromDate != null and fromDate != ''">
                AND a.use_start_date_time &gt;=
                STR_TO_DATE(CONCAT(#{fromDate}, ' 00:00:00'), '%Y-%m-%d %H:%i:%s')
            </if>
            <if test="toDate != null and toDate != ''">
                AND a.use_end_date_time &lt;=
                STR_TO_DATE(CONCAT(#{toDate}, ' 23:59:59'), '%Y-%m-%d %H:%i:%s')
            </if>
            <if test="reservationStatus != null and reservationStatus != ''">
                AND a.reservation_status = #{reservationStatus}
            </if>
        </where>
        ORDER BY a.use_start_date_time DESC
    </select>
</mapper>